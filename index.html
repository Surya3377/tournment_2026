<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2026 Pongal Tournament</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .container {
        max-width: 600px;
      }
      .custom-scroll::-webkit-scrollbar {
        display: none;
      }
      .custom-scroll {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 flex items-center justify-center min-h-screen p-4 custom-scroll"
  >
    <div
      class="container bg-white rounded-2xl shadow-xl p-8 space-y-8 flex flex-col items-center"
    >
      <header class="text-center space-y-2">
        <h1 class="text-4xl font-bold text-gray-800">2026 Pongal Tournament</h1>
      </header>

      <section class="w-full space-y-4">
        <div class="space-y-2">
          <label for="name" class="block text-gray-700 font-semibold"
            >1. Name</label
          >
          <input
            type="text"
            id="name"
            placeholder="Enter your full name"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300"
          />
        </div>

        <div class="space-y-2">
          <label for="tshirt-size" class="block text-gray-700 font-semibold"
            >2. T-shirt Size</label
          >
          <input
            type="text"
            id="tshirt-size"
            placeholder="Enter T-shirt size (e.g., L, XL)"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300"
          />
        </div>

        <div class="space-y-2">
          <label for="number" class="block text-gray-700 font-semibold"
            >3. T-shirt Number</label
          >
          <input
            type="text"
            id="number"
            placeholder="Enter T-shirt number"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300"
          />
        </div>

        <button
          id="register-button"
          class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 opacity-50 cursor-not-allowed"
          disabled
        >
          Loading...
        </button>
        <button
          id="cancel-edit-button"
          class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow-md hover:bg-gray-500 transition duration-300 hidden"
        >
          Cancel Edit
        </button>
        <div
          id="message"
          class="text-center p-2 rounded-lg text-sm transition-all duration-300 transform scale-y-0 h-0 opacity-0"
        ></div>
      </section>

      <section class="w-full space-y-4 pt-8 border-t border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 text-center">
          Registered Users
        </h2>
        <div id="user-list" class="space-y-4">
          <p id="loading-message" class="text-gray-500 text-center">
            Loading registered users...
          </p>
        </div>
      </section>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        setLogLevel,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // IMPORTANT: Use the dynamically provided Firebase configuration
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig = JSON.parse(
        typeof __firebase_config !== "undefined" ? __firebase_config : "{}"
      );
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Set log level for debugging Firestore.
      setLogLevel("debug");

      let userId = null;
      let currentDocId = null;
      let registrations = [];
      let db, auth;

      const registerButton = document.getElementById("register-button");
      const cancelButton = document.getElementById("cancel-edit-button");
      const nameInput = document.getElementById("name");
      const tshirtSizeInput = document.getElementById("tshirt-size");
      const numberInput = document.getElementById("number");
      const userListDiv = document.getElementById("user-list");
      const messageDiv = document.getElementById("message");
      const loadingMessage = document.getElementById("loading-message");

      // Function to display a temporary message
      function showMessage(text, classes) {
        messageDiv.textContent = text;
        messageDiv.className = `text-center p-2 rounded-lg text-sm transition-all duration-300 transform scale-y-100 h-auto opacity-100 ${classes}`;
        setTimeout(() => {
          messageDiv.className = `text-center p-2 rounded-lg text-sm transition-all duration-300 transform scale-y-0 h-0 opacity-0`;
        }, 3000);
      }

      // Initialize Firebase and set up the main auth listener
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      // Use the provided auth token if available, otherwise sign in anonymously
      async function authenticateUser() {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          showMessage(
            "Authentication failed. Please check the console for details.",
            "bg-red-200 text-red-700"
          );
        }
      }
      authenticateUser();

      // This listener will fire once the auth state is ready and every time it changes.
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          console.log("User authenticated with UID:", userId);
          registerButton.disabled = false;
          registerButton.textContent = "Register";
          registerButton.classList.remove("opacity-50", "cursor-not-allowed");
          registerButton.classList.add("hover:bg-blue-700");

          // Set up event listeners and Firestore listener ONLY when auth is ready
          setupEventListeners();
          setupFirestoreListener();
        } else {
          console.log("Authentication state changed: user is signed out.");
          registerButton.disabled = true;
          registerButton.textContent = "Authentication Failed";
          registerButton.classList.add("opacity-50", "cursor-not-allowed");
          registerButton.classList.remove("hover:bg-blue-700");
          showMessage(
            "Authentication failed. Please refresh the page.",
            "bg-red-200 text-red-700"
          );
        }
      });

      // Add or update a registration in Firestore
      function setupEventListeners() {
        registerButton.addEventListener("click", async () => {
          // IMPORTANT: Check for userId one last time before proceeding
          if (!userId) {
            showMessage(
              "Authentication not ready. Please wait a moment and try again.",
              "bg-red-200 text-red-700"
            );
            return;
          }

          const name = nameInput.value.trim();
          const tshirtSize = tshirtSizeInput.value.trim();
          const number = numberInput.value.trim();

          if (!name || !tshirtSize || !number) {
            showMessage(
              "Please fill in all fields.",
              "bg-red-200 text-red-700"
            );
            return;
          }

          // Construct the correct collection path using the provided app ID
          const registrationsCollectionPath = `/artifacts/${appId}/public/data/registrations`;
          const registrationsCollection = collection(
            db,
            registrationsCollectionPath
          );

          try {
            if (currentDocId) {
              // Update existing document
              const docRef = doc(db, registrationsCollectionPath, currentDocId);
              await updateDoc(docRef, {
                name,
                tshirtSize,
                number,
              });
              console.log("Data successfully updated in Firestore.");
              showMessage(
                "Registration updated successfully!",
                "bg-green-200 text-green-700"
              );
              // Reset form and UI
              nameInput.value = "";
              tshirtSizeInput.value = "";
              numberInput.value = "";
              registerButton.textContent = "Register";
              cancelButton.classList.add("hidden");
              currentDocId = null;
            } else {
              // Add a new document
              await addDoc(registrationsCollection, {
                name,
                tshirtSize,
                number,
                userId, // Store the user ID with the document
                timestamp: new Date(),
              });
              console.log("Data successfully sent to Firestore.");
              showMessage(
                "Registration successful!",
                "bg-green-200 text-green-700"
              );
              nameInput.value = "";
              tshirtSizeInput.value = "";
              numberInput.value = "";
            }
          } catch (e) {
            console.error("Error saving document: ", e);
            showMessage(
              "Error saving registration. Check the console for details.",
              "bg-red-200 text-red-700"
            );
          }
        });

        // Cancel edit operation
        cancelButton.addEventListener("click", () => {
          nameInput.value = "";
          tshirtSizeInput.value = "";
          numberInput.value = "";
          registerButton.textContent = "Register";
          cancelButton.classList.add("hidden");
          currentDocId = null;
          showMessage("Edit cancelled.", "bg-gray-200 text-gray-700");
        });

        // Event listener for edit buttons
        userListDiv.addEventListener("click", (e) => {
          if (e.target.classList.contains("edit-button")) {
            const docId = e.target.dataset.docId;
            const userDoc = registrations.find((item) => item.id === docId);

            if (userDoc) {
              nameInput.value = userDoc.name;
              tshirtSizeInput.value = userDoc.tshirtSize;
              numberInput.value = userDoc.number;
              currentDocId = docId;
              registerButton.textContent = "Update";
              cancelButton.classList.remove("hidden");
              showMessage(
                "Editing " + userDoc.name,
                "bg-blue-200 text-blue-700"
              );
              window.scrollTo({ top: 0, behavior: "smooth" });
            }
          }
        });
      }

      // Set up real-time listener for the registrations collection
      function setupFirestoreListener() {
        console.log("Attempting to set up Firestore listener...");
        const registrationsCollectionPath = `/artifacts/${appId}/public/data/registrations`;
        const registrationsCollection = collection(
          db,
          registrationsCollectionPath
        );

        onSnapshot(
          registrationsCollection,
          (querySnapshot) => {
            console.log("Data received from Firestore!");
            loadingMessage.style.display = "none";
            userListDiv.innerHTML = ""; // Clear the list

            registrations = [];
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              console.log("Processing document:", doc.id, data);
              registrations.push({ id: doc.id, ...data });
            });

            // Sort the registrations by timestamp for consistent ordering
            registrations.sort((a, b) => {
              const timestampA = a.timestamp ? a.timestamp.toDate() : 0;
              const timestampB = b.timestamp ? b.timestamp.toDate() : 0;
              return timestampA - timestampB;
            });

            if (registrations.length === 0) {
              userListDiv.innerHTML =
                '<p class="text-gray-500 text-center">No users registered yet. Be the first!</p>';
            } else {
              registrations.forEach((user) => {
                const userCard = document.createElement("div");
                userCard.className =
                  "bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0";

                const nameEl = document.createElement("p");
                nameEl.className = "text-lg font-semibold text-gray-800";
                nameEl.textContent = user.name || "N/A";

                const detailsEl = document.createElement("div");
                detailsEl.className =
                  "flex flex-col sm:flex-row sm:space-x-4 text-gray-600 text-sm w-full sm:w-auto";

                const sizeEl = document.createElement("p");
                sizeEl.innerHTML = `<span class="font-medium text-gray-500">T-shirt:</span> ${
                  user.tshirtSize || "N/A"
                }`;

                const numberEl = document.createElement("p");
                numberEl.innerHTML = `<span class="font-medium text-gray-500">Number:</span> ${
                  user.number || "N/A"
                }`;

                detailsEl.appendChild(sizeEl);
                detailsEl.appendChild(numberEl);

                userCard.appendChild(nameEl);
                userCard.appendChild(detailsEl);

                // Add edit button if the current user owns this registration
                if (user.userId === userId) {
                  const editButton = document.createElement("button");
                  editButton.className =
                    "edit-button ml-auto px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-xs font-semibold hover:bg-gray-300 transition duration-300";
                  editButton.textContent = "Edit";
                  editButton.dataset.docId = user.id;
                  userCard.appendChild(editButton);
                }

                userListDiv.appendChild(userCard);
              });
            }
          },
          (error) => {
            console.error("Error fetching documents:", error);
            loadingMessage.style.display = "none";
            userListDiv.innerHTML =
              '<p class="text-red-500 text-center">Failed to load users. Please check your internet connection.</p>';
          }
        );
      }
    </script>
  </body>
</html>
